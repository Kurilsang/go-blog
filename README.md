# 🚀 GoBlog - 高性能博客系统

基于 Go 语言和 Gin 框架构建的高性能博客系统，采用现代化技术栈，支持文章管理、用户认证、用户个人中心、汇率查询等功能，集成了高效的分页工具和缓存策略。

## ✨ 技术特性

- 🔐 **高性能JWT认证** - 基于 JWT 的无状态认证，内置用户ID，零数据库查询
- 🛡️ **RBAC 权限控制** - 基于角色的访问控制，支持多层权限验证
- 👤 **用户个人中心** - 完整的用户资料管理，支持邮箱、头像、个人简介等
- 🏗️ **分层架构设计** - Controller-Service-Model 三层架构，职责分离
- 📦 **独立DTO层** - 统一的数据传输对象，避免循环依赖
- 🚀 **高性能缓存** - Redis 缓存策略，防止缓存击穿，支持智能分页缓存
- 📃 **智能分页** - 自定义 GORM Scopes 分页工具，支持条件查询和排序
- 🔄 **组合模式中间件** - 可组合的验证器设计，灵活的权限控制
- 🛡️ **并发安全** - 原子操作和双重检查锁定模式
- 🎯 **RESTful API** - 标准化的 REST API 设计
- 🔧 **配置管理** - 基于 Viper 的灵活配置系统
- 🗄️ **数据库 ORM** - GORM 数据库操作和自动迁移
- 🌐 **跨域支持** - CORS 中间件支持前端跨域请求

## 🏗️ 技术架构

### 核心技术栈

| 技术 | 版本      | 用途 |
|------|---------|------|
| **Go** | 1.24.5  | 后端开发语言 |
| **Gin** | v1.10.1 | Web 框架 |
| **GORM** | v1.30.0 | ORM 框架 |
| **Redis** | v8.11.5 | 缓存数据库 |
| **MySQL** | v5.9+   | 主数据库 |
| **JWT** | v4.5.2  | 用户认证 |
| **Viper** | v1.20.1 | 配置管理 |

## 🔧 项目结构

```
go_test/
├── 📁 config/           # 配置管理
├── 📁 controller/       # 控制器层 (仅负责参数处理和响应封装)
│   ├── auth_controller.go         # 用户认证
│   ├── article_controller.go      # 文章管理
│   ├── user_controller.go         # 🆕 用户个人中心
│   └── exchange_rate_controller.go # 汇率查询
├── 📁 service/          # 🆕 业务逻辑层
│   ├── auth_service.go            # 认证业务逻辑
│   ├── article_service.go         # 文章业务逻辑
│   ├── user_service.go            # 用户业务逻辑
│   └── exchange_rate_service.go   # 汇率业务逻辑
├── 📁 dto/              # 🆕 数据传输对象层
│   └── dto.go                     # 统一DTO定义
├── 📁 model/           # 数据模型
├── 📁 middleware/      # 中间件
├── 📁 router/          # 路由管理
├── 📁 utils/           # 工具函数
│   ├── pagination.go  # 分页工具
│   ├── jwt.go         # 🆕 高性能JWT工具（包含用户ID）
│   └── password.go    # 密码工具
├── 📁 global/          # 全局变量
│   ├── global.go      # 数据库连接管理
│   └── constants.go   # 常量集中管理
├── 📁 sql/             # SQL脚本
└── main.go            # 应用入口
```

## 🚀 核心功能

### 🔐 高性能认证系统
- **🆕 零查询JWT认证** - JWT内置用户ID，认证过程无数据库查询
- **角色管理** - 支持 admin/user 角色控制
- Bcrypt 密码加密
- 中间件级别的权限控制
- **🆕 自动token升级** - 新登录用户自动获得高性能token

### 👤 用户个人中心系统
- **完整用户资料** - 支持邮箱、头像、昵称、个人简介、电话
- **安全资料修改** - 用户只能修改自己的资料，管理员无限制
- **密码安全更新** - 旧密码验证，新密码强度检查
- **邮箱唯一性验证** - 防止邮箱冲突
- **管理员用户管理** - 支持角色和状态管理

### 🛡️ RBAC 权限控制系统
- **分层权限验证** - JWT认证 → 角色验证 → 数据库状态验证
- **组合模式中间件** - 可组合的验证器，灵活配置权限级别
- **操作敏感度分级** - 根据操作风险选择验证策略
- **实时权限控制** - 敏感操作支持数据库实时验证

#### 权限分层架构
```go
// 普通操作 - JWT验证 (0次数据库查询)
AuthMiddleware()

// 管理操作 - JWT + 角色验证 (0次数据库查询)
AdminOnlyMiddleware()

// 敏感操作 - JWT + 角色验证 + 数据库状态验证 (1次数据库查询)
SensitiveAdminMiddleware()
```

### 📝 文章管理系统
- 文章的 CRUD 操作
- **智能分页查询** - 支持条件查询、排序和分页
- **搜索功能** - 全文搜索并支持分页
- **智能缓存** - 基于查询参数的精确缓存策略
- Redis 缓存策略
- 防缓存击穿机制

### 💱 汇率查询系统
- 汇率数据管理
- 实时汇率查询
- 数据持久化存储

## 🏛️ 分层架构设计

### 三层架构模式
```
┌─────────────────┐
│   Controller    │  ← 参数获取 + 响应封装
├─────────────────┤
│    Service      │  ← 业务逻辑处理
├─────────────────┤
│   Model/DTO     │  ← 数据模型 + 传输对象
└─────────────────┘
```

### 架构优势
- **职责分离** - Controller专注HTTP处理，Service专注业务逻辑
- **代码复用** - Service层可被多个Controller或其他模块调用
- **易于测试** - 业务逻辑独立，便于单元测试
- **维护性强** - 各层职责清晰，便于修改和扩展

## 🔒 并发安全设计

### 原子操作配置
```go
// 使用 atomic.Value 避免互斥锁性能损失
var appConfig atomic.Value
func GetAppConfig() *Config {
    return appConfig.Load().(*Config)
}
```

### 缓存击穿防护
```go
// 双重检查锁定模式
cacheMutex.Lock()
defer cacheMutex.Unlock()
// 双重检查防止重复查询数据库
```

### 单次初始化保证
```go
// sync.Once 确保全局资源只初始化一次
var dbOnce sync.Once
func InitDB(db *gorm.DB) {
    dbOnce.Do(func() {
        DB = db
    })
}
```

## 📃 分页工具设计

### 高效分页实现
```go
// 自定义 GORM Scopes 分页
type Paginate struct {
    Page     int    `json:"page"`
    PageSize int    `json:"page_size"`
    Total    int64  `json:"total"`
    Order    string `json:"order,omitempty"`
}

// 使用示例
paginate := utils.PaginateFromContext(ctx)
utils.PaginateWithTotal(global.DB, &model.Article{}, paginate, &articles)
```

### 分页特性
- **智能参数解析** - 从请求上下文自动解析分页参数
- **条件查询支持** - 保持 WHERE 条件的分页查询
- **排序集成** - 支持动态排序参数
- **性能优化** - 避免重复查询，优化 COUNT 和数据查询

## 🛠️ 快速开始

1. **克隆项目**
```bash
git clone https://github.com/Kurilsang/go-blog.git
cd goblog
```

2. **安装依赖**
```bash
go mod tidy
```

3. **启动数据库**
```bash
# 启动 MySQL 和 Redis
docker-compose up -d  # 如果使用 Docker
```

4. **配置环境**
```bash
# 修改 config/config.yml 配置文件
```

5. **启动服务**
```bash
go run main.go
```

## 📊 性能优化

- **🆕 零查询认证**: JWT内置用户ID，认证过程无数据库查询
- **智能缓存策略**: 多层缓存架构，精确缓存键设计
- **权限验证优化**: 分层验证策略，高频操作避免数据库查询
- **分页优化**: 基于 GORM Scopes 的高效分页实现
- **缓存击穿防护**: 双重检查锁定模式，防止缓存雪崩
- **连接池优化**: 数据库和 Redis 连接池优化
- **原子操作**: 无锁配置读取，高性能并发
- **中间件优化**: 组合模式设计，最小化中间件开销

## 🔍 技术亮点

### 🆕 高性能JWT认证系统
- **内置用户ID** - JWT包含用户ID，避免每次请求查库
- **性能对比** - 基础认证从1次查询优化至0次查询
- **向后兼容** - 支持新旧token格式平滑迁移
- **安全性保证** - 严格验证token完整性

### 🆕 分层架构设计
- **Controller瘦身** - 只负责参数获取和响应封装
- **Service集中化** - 业务逻辑统一管理，便于复用
- **DTO独立性** - 避免循环依赖，类型安全
- **测试友好** - 各层独立，便于单元测试

### 权限控制系统的设计优势
- **组合模式中间件** - 可组合的验证器设计，符合单一职责原则
- **分层权限验证** - 根据操作敏感度选择不同的验证策略
- **高性能认证** - JWT验证无数据库查询，敏感操作才查数据库
- **实时权限控制** - 管理员权限变更立即生效

### 智能缓存策略
- **精确缓存键** - 基于分页参数MD5哈希，避免缓存冲突
- **缓存分层管理** - 全量缓存 + 分页缓存 + 搜索缓存
- **缓存击穿防护** - 双重检查锁定模式防止缓存雪崩
- **自动缓存失效** - 数据变更时智能清除相关缓存

### 分页工具的技术优势
- **代码复用性** - 单一分页工具支持所有查询场景
- **类型安全** - 基于 Go 强类型系统的参数验证
- **性能优化** - 避免不必要的数据库查询
- **扩展性强** - 支持复杂条件查询和动态排序

### 中间件架构设计
- **职责分离** - JWT解析、角色验证、状态检查独立实现
- **高度可测试** - 每个验证器可独立进行单元测试
- **易于扩展** - 新增验证需求只需添加新的验证器
- **组合灵活** - 可根据业务需求灵活组合不同的验证器

## 📄 许可证

本项目采用 MIT 许可证

---

⭐ 如果这个项目对你有帮助，请给它一个星标！ 